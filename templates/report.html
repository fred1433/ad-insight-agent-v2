<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapport d'Analyse - {{ report.ad_id }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* On garde un peu de style spécifique au rapport ici */
        body { background-color: #f8f9fa; }
        .report-header { text-align: center; margin-bottom: 40px; }
        .report-section { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 40px; }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; align-items: start; }
        video, img { max-width: 100%; height: auto; border-radius: 8px; }
        td img { max-width: 200px; } /* Style pour les petites images de concept */
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="report-header">
            <h1>Rapport d'Analyse de Performance</h1>
            <p class="lead text-muted">Client: {{ report.client_name }} | Ad ID: {{ report.ad_id }}</p>
            <a href="/" class="btn btn-secondary mt-3">Retour à la liste</a>
        </div>

        <!-- Section Média Principal & KPIs -->
        <div class="report-section">
            <h2>Créatif Publicitaire & KPIs</h2>
            <div class="grid-container">
                <!-- Colonne Média -->
                <div>
                    <h3>Média Principal</h3>
                    {% if report.report_path %}
                        {% set filename = report.report_path.split('/')[-1] %}
                        {% if filename.endswith('.mp4') or filename.endswith('.mov') %}
                            <video controls>
                                <source src="{{ url_for('serve_storage_file', filename=filename) }}" type="video/mp4">
                                Votre navigateur ne supporte pas la lecture de vidéos.
                            </video>
                        {% else %}
                            <img src="{{ url_for('serve_storage_file', filename=filename) }}" alt="Média de l'annonce">
                        {% endif %}
                    {% else %}
                        <p class="text-muted">Aucun média principal associé à ce rapport.</p>
                    {% endif %}
                </div>

                <!-- Colonne KPIs -->
                <div>
                    <h3>Indicateurs de Performance</h3>
                    {% if insights %}
                        <table class="table table-striped">
                            <tbody>
                                <tr>
                                    <td><strong>Dépense</strong></td>
                                    <td class="text-end">{{"${:,.2f}".format(insights.spend)}}</td>
                                </tr>
                                <tr>
                                    <td><strong>CPA (Coût par Achat)</strong></td>
                                    <td class="text-end">{{"${:,.2f}".format(insights.cpa)}}</td>
                                </tr>
                                <tr>
                                    <td><strong>Achats</strong></td>
                                    <td class="text-end">{{ insights.website_purchases }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Valeur des achats</strong></td>
                                    <td class="text-end">{{"${:,.2f}".format(insights.website_purchases_value)}}</td>
                                </tr>
                                <tr>
                                    <td><strong>ROAS</strong></td>
                                    <td class="text-end">{{ "{:.2f}x".format(insights.roas) }}</td>
                                </tr>
                                <tr>
                                    <td><strong>CPM</strong></td>
                                    <td class="text-end">{{"${:,.2f}".format(insights.cpm)}}</td>
                                </tr>
                                <tr>
                                    <td><strong>CTR (unique)</strong></td>
                                    <td class="text-end">{{ "{:.2f} %".format(insights.unique_ctr) }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Fréquence</strong></td>
                                    <td class="text-end">{{ "{:.2f}".format(insights.frequency) }}</td>
                                </tr>
                                {% if insights.hook_rate is not none and insights.hold_rate is not none %}
                                <tr>
                                    <td><strong>Taux d'accroche (Hook Rate)</strong></td>
                                    <td class="text-end">{{ "{:.2f} %".format(insights.hook_rate) }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Taux de rétention (Hold Rate)</strong></td>
                                    <td class="text-end">{{ "{:.2f} %".format(insights.hold_rate) }}</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    {% else %}
                        <p class="text-muted">Les indicateurs de performance pour cette annonce n'ont pas pu être récupérés.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Section Analyse IA -->
        <div class="report-section">
            <h2>Analyse Qualitative de l'IA</h2>
            <div id="analysis-content">
                {{ report.analysis_html|safe }}
            </div>
        </div>

        <!-- Section Nouveaux Concepts -->
        <div class="report-section">
            <h2>Nouveaux Concepts Créatifs (Guiones)</h2>
            <p>Le client souhaite pouvoir modifier le texte dans cette section.</p>
            <button id="edit-button" class="btn btn-primary mb-3">Activer l'édition</button>
            <button id="save-button" class="btn btn-success mb-3" style="display:none;">Sauvegarder</button>
            <div id="script-content" contenteditable="false">
                {{ report.script_html|safe }}
            </div>
             <div id="save-status" class="mt-2"></div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const editButton = document.getElementById('edit-button');
        const saveButton = document.getElementById('save-button');
        const scriptContent = document.getElementById('script-content');
        const saveStatus = document.getElementById('save-status');
        const reportId = {{ report.id }};

        editButton.addEventListener('click', function() {
            scriptContent.setAttribute('contenteditable', 'true');
            scriptContent.style.border = '2px solid #0d6efd';
            scriptContent.style.padding = '10px';
            scriptContent.focus();
            
            editButton.style.display = 'none';
            saveButton.style.display = 'inline-block';
        });

        saveButton.addEventListener('click', function() {
            const updatedHtml = scriptContent.innerHTML;

            saveButton.disabled = true;
            saveButton.textContent = 'Sauvegarde...';

            fetch(`/report/${reportId}/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ script_html: updatedHtml })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    scriptContent.setAttribute('contenteditable', 'false');
                    scriptContent.style.border = 'none';
                    scriptContent.style.padding = '0';
                    
                    editButton.style.display = 'inline-block';
                    saveButton.style.display = 'none';

                    saveStatus.className = 'alert alert-success';
                    saveStatus.textContent = 'Sauvegarde réussie !';
                } else {
                    saveStatus.className = 'alert alert-danger';
                    saveStatus.textContent = 'Erreur: ' + data.message;
                }
            })
            .catch(error => {
                saveStatus.className = 'alert alert-danger';
                saveStatus.textContent = 'Erreur de communication.';
                console.error('Error:', error);
            })
            .finally(() => {
                saveButton.disabled = false;
                saveButton.textContent = 'Sauvegarder';
                setTimeout(() => { saveStatus.textContent = ''; saveStatus.className=''; }, 3000);
            });
        });
    });
    </script>
</body>
</html> 